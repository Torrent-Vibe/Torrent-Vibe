name: ðŸ–¥ï¸ Build Desktop

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      build_macos:
        type: boolean
        description: 'Build for macOS'
        default: true
      build_ubuntu:
        type: boolean
        description: 'Build for Ubuntu Linux'
        default: true
      build_windows:
        type: boolean
        description: 'Build for Windows'
        default: true
      build_web:
        type: boolean
        description: 'Build Web version'
        default: true

# https://docs.github.com/en/enterprise-cloud@latest/actions/writing-workflows/choosing-what-your-workflow-does/control-the-concurrency-of-workflows-and-jobs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-build
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' && github.ref != 'refs/heads/dev' }}
env:
  NODE_OPTIONS: --max-old-space-size=8192

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      platforms: ${{ steps.parse-platforms.outputs.platforms }}
      tag_name: ${{ steps.compute-tag.outputs.tag_name }}
    steps:
      - name: Parse platforms input
        id: parse-platforms
        run: |
          # Collect selected platforms based on boolean inputs
          platforms=""

          if [ "${{ github.event.inputs.build_macos }}" = "true" ]; then
            platforms="$platforms\"macos-latest\","
          fi

          if [ "${{ github.event.inputs.build_ubuntu }}" = "true" ]; then
            platforms="$platforms\"ubuntu-latest\","
          fi

          if [ "${{ github.event.inputs.build_windows }}" = "true" ]; then
            platforms="$platforms\"windows-latest\","
          fi

          # Remove trailing comma and wrap in brackets
          platforms_json="[${platforms%,}]"

          echo "platforms=$platforms_json" >> $GITHUB_OUTPUT
          echo "Parsed platforms: $platforms_json"

      - name: Compute tag name
        id: compute-tag
        run: |
          UTC_TAG=$(date -u +%Y%m%d%H%M%S)
          TAG_NAME="v$UTC_TAG"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Computed tag: $TAG_NAME"

  release:
    needs: setup
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: ${{ fromJSON(needs.setup.outputs.platforms) }}
        exclude:
          - os: ${{ github.event.inputs.store == 'true' && 'ubuntu-latest' }}

    permissions:
      id-token: write
      contents: write

    steps:
      - name: Check out Git repository Fully
        uses: actions/checkout@v5

        with:
          fetch-depth: 1
          lfs: true

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm i

      - name: Build (Windows/Linux)
        if: runner.os == 'Linux' || runner.os == 'Windows'
        run: pnpm electron:build && pnpm electron:make
        env:
          APP_VERSION: ${{ needs.setup.outputs.tag_name }}

      - name: Build - macOS (dual-arch)
        if: runner.os == 'macOS'
        run: |
          APP_VERSION=${{ needs.setup.outputs.tag_name }} npx electron-vite build
          APP_VERSION=${{ needs.setup.outputs.tag_name }} npx electron-forge make --arch=x64 --platform=darwin
          APP_VERSION=${{ needs.setup.outputs.tag_name }} npx electron-forge make --arch=arm64 --platform=darwin

      - name: Prepare release files (Windows)
        if: runner.os == 'Windows'
        run: |
          New-Item -ItemType Directory -Force -Path release
          if (Test-Path "out/make") {
            Get-ChildItem -Path "out/make" -Recurse -Include "*.dmg","*.AppImage","*.exe","*.zip","*.yml" | Copy-Item -Destination "release/"
          }
        shell: pwsh

      - name: Prepare release files (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p release
          if [ -d "out/make" ]; then
            find out/make -type f \( -name "*.dmg" -o -name "*.AppImage" -o -name "*.exe" -o -name "*.zip" -o -name "*.yml" \) -exec cp {} release/ \;
          fi
        shell: bash

      - name: Refresh macOS updater metadata
        if: runner.os == 'macOS'
        run: |
          RELEASE_DIR="$PWD/out/make"
          ARM64_FINAL=$(find "$RELEASE_DIR" -maxdepth 1 -type f -name "*darwin-arm64*.zip" -print -quit)
          X64_FINAL=$(find "$RELEASE_DIR" -maxdepth 1 -type f -name "*darwin-x64*.zip" -print -quit)
          if [ -z "$ARM64_FINAL" ] || [ -z "$X64_FINAL" ]; then
            echo "[-] Failed to locate macOS zips in $RELEASE_DIR" >&2
            find "$RELEASE_DIR" -maxdepth 1 -type f -name "*.zip" -print || true
            exit 1
          fi
          node scripts/generate-electron-metadata.js \
            --version "${{ needs.setup.outputs.tag_name }}" \
            --artifact "path=$ARM64_FINAL,platform=darwin,arch=arm64" \
            --artifact "path=$X64_FINAL,platform=darwin,arch=x64"

      - name: Generate app manifest (mainHash)
        shell: bash
        run: |
          node scripts/generate-app-build-manifest.js \
            --output release/manifest.yaml \
            --tag ${{ needs.setup.outputs.tag_name }}

      - name: Upload desktop artifacts to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.setup.outputs.tag_name }}
          name: Release ${{ needs.setup.outputs.tag_name }}
          generate_release_notes: ${{ matrix.os == 'macos-latest' }}
          fail_on_unmatched_files: false
          append_body: true
          make_latest: ${{ matrix.os == 'macos-latest' }}
          files: |
            release/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-web:
    needs: setup
    runs-on: ubuntu-latest
    if: github.event.inputs.build_web != 'false'

    permissions:
      contents: write

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm i

      - name: Build Web Production
        run: pnpm run build:production

      - name: Create web artifact archive
        run: |
          cd layer/renderer/dist
          mkdir -p public
          find . -maxdepth 1 -mindepth 1 ! -name public -exec mv {} public/ \;
          tar -czf ../../../qb-client-webui-web.tar.gz public/

      - name: Upload web artifacts to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.setup.outputs.tag_name }}
          name: Release ${{ needs.setup.outputs.tag_name }}
          generate_release_notes: false
          fail_on_unmatched_files: false
          append_body: true
          make_latest: false
          files: |
            qb-client-webui-web.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
